<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lipana TPS — Dashboard</title>
    <style>
        :root {
            --bg: #0f172a; --surface: #1e293b; --surface2: #334155;
            --border: #475569; --text: #e2e8f0; --text-muted: #94a3b8;
            --primary: #3b82f6; --primary-hover: #2563eb;
            --green: #22c55e; --red: #ef4444; --amber: #f59e0b;
            --radius: 8px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        a { color: var(--primary); text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Layout */
        .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header h1 span { color: var(--primary); }
        .header .conn { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-muted); }
        .header .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--red); }
        .header .dot.ok { background: var(--green); }

        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }

        /* Auth bar */
        .auth-bar { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; margin-bottom: 24px; display: flex; gap: 12px; align-items: end; }
        .auth-bar .field { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .auth-bar label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; }
        .auth-bar input { background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 8px 12px; color: var(--text); font-size: 14px; }
        .auth-bar input:focus { outline: none; border-color: var(--primary); }
        .btn { background: var(--primary); color: #fff; border: none; border-radius: 4px; padding: 9px 20px; font-size: 14px; cursor: pointer; white-space: nowrap; }
        .btn:hover { background: var(--primary-hover); }
        .btn:disabled { opacity: .5; cursor: not-allowed; }
        .btn-sm { padding: 6px 14px; font-size: 13px; }

        /* Stats cards */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
        .card .label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 4px; }
        .card .value { font-size: 28px; font-weight: 700; }
        .card .value.alert { color: var(--red); }
        .card .value.safe { color: var(--green); }
        .card .value.total { color: var(--primary); }

        /* Tabs */
        .tabs { display: flex; gap: 0; margin-bottom: 0; }
        .tab { padding: 10px 20px; font-size: 14px; cursor: pointer; background: var(--surface); border: 1px solid var(--border); border-bottom: none; border-radius: var(--radius) var(--radius) 0 0; color: var(--text-muted); }
        .tab.active { background: var(--surface2); color: var(--text); border-color: var(--primary); }
        .tab-content { background: var(--surface2); border: 1px solid var(--border); border-radius: 0 var(--radius) var(--radius) var(--radius); padding: 20px; margin-bottom: 24px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Submit form */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label { font-size: 12px; color: var(--text-muted); }
        .form-group input, .form-group select { background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 8px 12px; color: var(--text); font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .form-actions { grid-column: 1 / -1; margin-top: 8px; display: flex; gap: 12px; align-items: center; }
        .form-result { margin-top: 12px; padding: 12px; background: var(--bg); border-radius: 4px; font-family: monospace; font-size: 13px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }

        /* Results table */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 10px 12px; font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; border-bottom: 1px solid var(--border); }
        td { padding: 10px 12px; border-bottom: 1px solid var(--surface); }
        tr:hover { background: rgba(59, 130, 246, .05); }
        .badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-alrt { background: rgba(239,68,68,.15); color: var(--red); }
        .badge-nalt { background: rgba(34,197,94,.15); color: var(--green); }

        /* Pagination */
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; font-size: 13px; color: var(--text-muted); }

        /* Detail modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-overlay.show { display: flex; }
        .modal { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); width: 90%; max-width: 720px; max-height: 80vh; overflow-y: auto; padding: 24px; }
        .modal h2 { margin-bottom: 16px; font-size: 18px; }
        .modal pre { background: var(--bg); padding: 12px; border-radius: 4px; font-size: 13px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; }
        .modal .close { float: right; background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; }

        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin .6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty { text-align: center; padding: 40px; color: var(--text-muted); }
    </style>
</head>
<body>

<div class="header">
    <h1><span>Lipana</span> TPS</h1>
    <div class="conn">
        <div class="dot" id="statusDot"></div>
        <span id="statusText">Disconnected</span>
    </div>
</div>

<div class="container">

    <!-- Auth -->
    <div class="auth-bar">
        <div class="field">
            <label>API Key</label>
            <input type="password" id="apiKey" placeholder="Enter your X-API-Key" />
        </div>
        <div class="field" style="max-width:200px">
            <label>Tenant ID</label>
            <input type="text" id="tenantId" value="DEFAULT" />
        </div>
        <button class="btn" onclick="connect()">Connect</button>
    </div>

    <!-- Stats -->
    <div class="stats" id="statsGrid">
        <div class="card"><div class="label">Total Evaluations</div><div class="value total" id="statTotal">—</div></div>
        <div class="card"><div class="label">Alerts (ALRT)</div><div class="value alert" id="statAlerts">—</div></div>
        <div class="card"><div class="label">No Alert (NALT)</div><div class="value safe" id="statNalt">—</div></div>
        <div class="card"><div class="label">Event History TXs</div><div class="value" id="statTx">—</div></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="results" onclick="switchTab('results')">Results</div>
        <div class="tab" data-tab="submit" onclick="switchTab('submit')">Submit Transaction</div>
        <div class="tab" data-tab="lookup" onclick="switchTab('lookup')">Lookup by MsgId</div>
    </div>

    <div class="tab-content">
        <!-- Results Tab -->
        <div class="tab-panel active" id="panel-results">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div>
                    <select id="statusFilter" onchange="loadResults(1)" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:6px 10px;color:var(--text);font-size:13px;">
                        <option value="">All statuses</option>
                        <option value="ALRT">Alerts only</option>
                        <option value="NALT">No-alert only</option>
                    </select>
                </div>
                <button class="btn btn-sm" onclick="loadResults(currentPage)">↻ Refresh</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Transaction ID</th>
                            <th>Status</th>
                            <th>Evaluated At</th>
                            <th>Typologies</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr><td colspan="6" class="empty">Connect with your API key to load results</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <span id="pageInfo">—</span>
                <div>
                    <button class="btn btn-sm" id="prevBtn" onclick="loadResults(currentPage-1)" disabled>← Prev</button>
                    <button class="btn btn-sm" id="nextBtn" onclick="loadResults(currentPage+1)" disabled>Next →</button>
                </div>
            </div>
        </div>

        <!-- Submit Tab -->
        <div class="tab-panel" id="panel-submit">
            <div class="form-grid">
                <div class="form-group">
                    <label>Debtor Member (DFSP)</label>
                    <input type="text" id="fDebtor" value="dfsp001" />
                </div>
                <div class="form-group">
                    <label>Creditor Member (DFSP)</label>
                    <input type="text" id="fCreditor" value="dfsp002" />
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="fAmount" value="100.50" step="0.01" min="0.01" />
                </div>
                <div class="form-group">
                    <label>Currency</label>
                    <input type="text" id="fCurrency" value="USD" maxlength="3" />
                </div>
                <div class="form-group">
                    <label>Transaction Status</label>
                    <select id="fStatus">
                        <option value="ACCC">ACCC — Accepted</option>
                        <option value="RJCT">RJCT — Rejected</option>
                    </select>
                </div>
                <div class="form-group"></div>
                <div class="form-actions">
                    <button class="btn" id="submitBtn" onclick="submitTx()">Submit Transaction</button>
                    <span id="submitSpinner" style="display:none"><span class="spinner"></span></span>
                </div>
            </div>
            <div class="form-result" id="submitResult" style="display:none"></div>
        </div>

        <!-- Lookup Tab -->
        <div class="tab-panel" id="panel-lookup">
            <div style="display:flex;gap:12px;align-items:end;">
                <div class="form-group" style="flex:1">
                    <label>Message ID (MsgId)</label>
                    <input type="text" id="lookupMsgId" placeholder="e.g. e24562287a264651b0c42a3de9ea44fe" />
                </div>
                <button class="btn" onclick="lookupById()">Lookup</button>
            </div>
            <div class="form-result" id="lookupResult" style="display:none"></div>
        </div>
    </div>
</div>

<!-- Detail modal -->
<div class="modal-overlay" id="detailModal">
    <div class="modal">
        <button class="close" onclick="closeModal()">✕</button>
        <h2 id="modalTitle">Evaluation Detail</h2>
        <pre id="modalBody"></pre>
    </div>
</div>

<script>
    const BASE = window.location.origin;
    let currentPage = 1;

    function getHeaders() {
        return {
            'Content-Type': 'application/json',
            'X-API-Key': document.getElementById('apiKey').value.trim(),
        };
    }

    function getTenant() {
        return document.getElementById('tenantId').value.trim() || 'DEFAULT';
    }

    function switchTab(name) {
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + name));
    }

    async function connect() {
        const dot = document.getElementById('statusDot');
        const txt = document.getElementById('statusText');
        try {
            const resp = await fetch(`${BASE}/api/v1/results/stats/summary?tenant_id=${getTenant()}`, { headers: getHeaders() });
            if (!resp.ok) throw new Error(resp.status);
            const data = await resp.json();
            dot.classList.add('ok');
            txt.textContent = 'Connected';
            document.getElementById('statTotal').textContent = data.evaluations_total;
            document.getElementById('statAlerts').textContent = data.alerts;
            document.getElementById('statNalt').textContent = data.no_alerts;
            document.getElementById('statTx').textContent = data.event_history_transactions;
            loadResults(1);
        } catch (e) {
            dot.classList.remove('ok');
            txt.textContent = 'Error: ' + e.message;
        }
    }

    async function loadResults(page) {
        if (page < 1) return;
        currentPage = page;
        const status = document.getElementById('statusFilter').value;
        let url = `${BASE}/api/v1/results?tenant_id=${getTenant()}&page=${page}&per_page=15`;
        if (status) url += `&status=${status}`;
        try {
            const resp = await fetch(url, { headers: getHeaders() });
            const data = await resp.json();
            const tbody = document.getElementById('resultsBody');
            if (!data.results || data.results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">No results found</td></tr>';
            } else {
                tbody.innerHTML = data.results.map(r => `
                    <tr>
                        <td>${r.id || '—'}</td>
                        <td style="font-family:monospace;font-size:12px">${r.transaction_id || '—'}</td>
                        <td><span class="badge badge-${(r.status||'').toLowerCase()}">${r.status || '—'}</span></td>
                        <td style="font-size:13px">${r.evaluated_at ? new Date(r.evaluated_at).toLocaleString() : '—'}</td>
                        <td>${Array.isArray(r.typology_results) ? r.typology_results.length : '—'}</td>
                        <td><button class="btn btn-sm" onclick="viewDetail('${r.transaction_id}')">View</button></td>
                    </tr>
                `).join('');
            }
            const totalPages = Math.ceil(data.total / data.per_page) || 1;
            document.getElementById('pageInfo').textContent = `Page ${page} of ${totalPages} (${data.total} total)`;
            document.getElementById('prevBtn').disabled = page <= 1;
            document.getElementById('nextBtn').disabled = page >= totalPages;
        } catch (e) {
            document.getElementById('resultsBody').innerHTML = `<tr><td colspan="6" class="empty">Error: ${e.message}</td></tr>`;
        }
    }

    async function viewDetail(msgId) {
        try {
            const resp = await fetch(`${BASE}/api/v1/results/${msgId}?tenant_id=${getTenant()}`, { headers: getHeaders() });
            const data = await resp.json();
            document.getElementById('modalTitle').textContent = `Evaluation: ${msgId}`;
            document.getElementById('modalBody').textContent = JSON.stringify(data, null, 2);
            document.getElementById('detailModal').classList.add('show');
        } catch (e) {
            alert('Failed to load detail: ' + e.message);
        }
    }

    function closeModal() { document.getElementById('detailModal').classList.remove('show'); }
    document.getElementById('detailModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });

    async function submitTx() {
        const btn = document.getElementById('submitBtn');
        const spinner = document.getElementById('submitSpinner');
        const result = document.getElementById('submitResult');
        btn.disabled = true; spinner.style.display = 'inline';
        try {
            const body = {
                debtor_member: document.getElementById('fDebtor').value,
                creditor_member: document.getElementById('fCreditor').value,
                amount: parseFloat(document.getElementById('fAmount').value),
                currency: document.getElementById('fCurrency').value,
                status: document.getElementById('fStatus').value,
                tenant_id: getTenant(),
            };
            const resp = await fetch(`${BASE}/api/v1/transactions/evaluate`, {
                method: 'POST', headers: getHeaders(), body: JSON.stringify(body),
            });
            const data = await resp.json();
            result.style.display = 'block';
            result.textContent = JSON.stringify(data, null, 2);
            // Refresh stats after a short delay
            setTimeout(() => { connect(); }, 3000);
        } catch (e) {
            result.style.display = 'block';
            result.textContent = 'Error: ' + e.message;
        } finally {
            btn.disabled = false; spinner.style.display = 'none';
        }
    }

    async function lookupById() {
        const msgId = document.getElementById('lookupMsgId').value.trim();
        const result = document.getElementById('lookupResult');
        if (!msgId) return;
        try {
            const resp = await fetch(`${BASE}/api/v1/results/${msgId}?tenant_id=${getTenant()}`, { headers: getHeaders() });
            const data = await resp.json();
            result.style.display = 'block';
            result.textContent = JSON.stringify(data, null, 2);
        } catch (e) {
            result.style.display = 'block';
            result.textContent = 'Error: ' + e.message;
        }
    }

    // Enter key triggers connect
    document.getElementById('apiKey').addEventListener('keydown', e => { if (e.key === 'Enter') connect(); });
</script>

</body>
</html>
